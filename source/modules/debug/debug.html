<include includeType="embed" source="consts.js" />
<include includeType="embed" source="utils.js" />
<include includeType="embed" source="ko_bindings.js" />
<include includeType="embed" source="command_dispatcher.js" />
<include includeType="embed" source="registers.js" />
<include includeType="embed" source="dasm_record.js" />
<include includeType="embed" source="ports.js" />
<include includeType="embed" source="memory.html" />
<include includeType="embed" source="dasm.js" />

<style>
	.debugger { font: 14px Consolas, monospace; box-sizing: border-box; position: relative; }
	.debugger .hex-edit-control, 
	.debugger .text-edit-control { position: absolute; z-index: 9999; margin: 0; border: 0; outline: 0; padding: 0; background-color: #ffffff; text-align: center; font: 14px Consolas, monospace; box-sizing: border-box; }

	.debugger-row { }
	.debugger-row > .debugger-block { display: inline-block; border: 1px solid #444444; border-left-style: none; border-top-style: none; vertical-align: top; }
	.debugger-row:first > .debugger-block { border-top-style: solid; }
	.debugger-row > .debugger-block:first { border-left-style: solid; }
	.debugger-row > .debugger-block > .header { height: 18px; background-color: #444444; color: #ffffff; text-align: center; }

	.debugger .toolbar { border: none; border-top: 1px solid #444444; height: 18px; }
	.debugger .toolbar-button { display: inline-block; cursor: pointer; width: 18px; height: 18px; background-color: transparent; background-repeat: no-repeat; background-position: center center; border: 0; vertical-align: top; }
	.debugger .toolbar-button:hover { background-color: #aaf7ff; }
	.debugger .toolbar-separator { display: inline-block; width: 1px; height: 18px; margin: 0 4px; background-color: #cccccc; vertical-align: top; }
	.debugger .toolbar-button.-button_break { background-image: url('data:image/svg+xml,<svg width="16px" height="16px" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="%23000000"><path d="M2 2v12h12V2H2zm10.75 10.75h-9.5v-9.5h9.5v9.5z"/></svg>'); }
	.debugger .toolbar-button.-button_run { background-image: url('data:image/svg+xml,<svg width="16px" height="16px" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="%23000000"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.25 3l1.166-.624 8 5.333v1.248l-8 5.334-1.166-.624V3zm1.5 1.401v7.864l5.898-3.932L5.75 4.401z"/></svg>'); }
	.debugger .toolbar-button.-button_step-over { background-image: url('data:image/svg+xml,<svg width="16px" height="16px" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="%23000000"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.25 5.75v-4h-1.5v2.542c-1.145-1.359-2.911-2.209-4.84-2.209-3.177 0-5.92 2.307-6.16 5.398l-.02.269h1.501l.022-.226c.212-2.195 2.202-3.94 4.656-3.94 1.736 0 3.244.875 4.05 2.166h-2.83v1.5h4.163l.962-.975V5.75h-.004zM8 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></svg>'); }
	.debugger .toolbar-button.-button_step-in { background-image: url('data:image/svg+xml,<svg width="16px" height="16px" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="%23000000"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 9.532h.542l3.905-3.905-1.061-1.06-2.637 2.61V1H7.251v6.177l-2.637-2.61-1.061 1.06 3.905 3.905H8zm1.956 3.481a2 2 0 1 1-4 0 2 2 0 0 1 4 0z"/></svg>'); }
	.debugger .toolbar-button.-button_run-until-cursor { background-image: url('data:image/svg+xml,<svg width="16px" height="16px" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="%23000000" transform="rotate(270)"><g id="SVGRepo_bgCarrier" stroke-width="0"/><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"/><g id="SVGRepo_iconCarrier"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 9.532h.542l3.905-3.905-1.061-1.06-2.637 2.61V1H7.251v6.177l-2.637-2.61-1.061 1.06 3.905 3.905H8zm1.956 3.481a2 2 0 1 1-4 0 2 2 0 0 1 4 0z"/></g></svg>'); }
	.debugger .toolbar-button.-button_run-until-address { background-image: url('data:image/svg+xml,<svg width="16px" height="16px" fill="%23000000" version="1.1" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path transform="rotate(-90,8,8.0065)" d="m8 9.532h0.542l3.905-3.905-1.061-1.06-2.637 2.61v-6.177h-1.498v6.177l-2.637-2.61-1.061 1.06 3.905 3.905z" clip-rule="evenodd" fill-rule="evenodd"/><path d="m11.262 13.532h-2.247v1.498h5.992v-1.498h-2.247v-11.05h2.247v-1.498h-5.992v1.498h2.247z" fill="%23000" stroke-width=".02"/></svg>'); }
	.debugger .toolbar-button.-button_toggle-bp-at-cursor { background-image: url('data:image/svg+xml,<svg width="16px" height="16px" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="%23000000"><path d="M8 4c.367 0 .721.048 1.063.145a3.943 3.943 0 0 1 1.762 1.031 3.944 3.944 0 0 1 1.03 1.762c.097.34.145.695.145 1.062 0 .367-.048.721-.145 1.063a3.94 3.94 0 0 1-1.03 1.765 4.017 4.017 0 0 1-1.762 1.031C8.72 11.953 8.367 12 8 12s-.721-.047-1.063-.14a4.056 4.056 0 0 1-1.765-1.032A4.055 4.055 0 0 1 4.14 9.062 3.992 3.992 0 0 1 4 8c0-.367.047-.721.14-1.063a4.02 4.02 0 0 1 .407-.953A4.089 4.089 0 0 1 5.98 4.546a3.94 3.94 0 0 1 .957-.401A3.89 3.89 0 0 1 8 4z"/></svg>'); }
	.debugger .toolbar-button.-button_toggle-bp-at-address { background-image: url('data:image/svg+xml,<svg width="16px" height="16px" fill="%23000000" version="1.1" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="m4.9835 4c0.367 0 0.721 0.048 1.063 0.145a3.943 3.943 0 0 1 1.762 1.031 3.944 3.944 0 0 1 1.03 1.762c0.097 0.34 0.145 0.695 0.145 1.062s-0.048 0.721-0.145 1.063a3.94 3.94 0 0 1-1.03 1.765 4.017 4.017 0 0 1-1.762 1.031c-0.343 0.094-0.696 0.141-1.063 0.141s-0.721-0.047-1.063-0.14a4.056 4.056 0 0 1-1.765-1.032 4.055 4.055 0 0 1-1.032-1.766 3.992 3.992 0 0 1-0.14-1.062c0-0.367 0.047-0.721 0.14-1.063a4.02 4.02 0 0 1 0.407-0.953 4.089 4.089 0 0 1 1.433-1.438 3.94 3.94 0 0 1 0.957-0.401 3.89 3.89 0 0 1 1.063-0.145z"/><path d="m11.262 13.532h-2.247v1.498h5.992v-1.498h-2.247v-11.05h2.247v-1.498h-5.992v1.498h2.247z" fill="%23000" stroke-width=".02"/></svg>'); }
	.debugger .toolbar-button.-button_prev-page { background-image: url('data:image/svg+xml,<svg width="16px" height="16px" fill="%23000000" version="1.1" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="m7.32 7.976 4.357 4.357-0.618 0.62-4.667-4.669v-0.618l4.667-4.666 0.618 0.619z" clip-rule="evenodd" fill-rule="evenodd"/><path d="m4.536 7.976 4.357 4.357-0.618 0.62-4.667-4.669v-0.618l4.667-4.666 0.618 0.619z" clip-rule="evenodd" fill-rule="evenodd"/></svg>'); }
	.debugger .toolbar-button.-button_prev { background-image: url('data:image/svg+xml,<svg width="16px" height="16px" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="%23000000"><path fill-rule="evenodd" clip-rule="evenodd" d="M5.928 7.976l4.357 4.357-.618.62L5 8.284v-.618L9.667 3l.618.619-4.357 4.357z"/></svg>'); }
	.debugger .toolbar-button.-button_next { background-image: url('data:image/svg+xml,<svg width="16px" height="16px" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="%23000000"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.072 8.024L5.715 3.667l.618-.62L11 7.716v.618L6.333 13l-.618-.619 4.357-4.357z"/></svg>'); }
	.debugger .toolbar-button.-button_next-page { background-image: url('data:image/svg+xml,<svg width="16px" height="16px" fill="%23000000" version="1.1" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="m8.68 8.024-4.357-4.357 0.618-0.62 4.667 4.669v0.618l-4.667 4.666-0.618-0.619z" clip-rule="evenodd" fill-rule="evenodd"/><path d="m11.464 8.024-4.357-4.357 0.618-0.62 4.667 4.669v0.618l-4.667 4.666-0.618-0.619z" clip-rule="evenodd" fill-rule="evenodd"/></svg>'); }
	.debugger .toolbar-button.-button_load { background-image: url('data:image/svg+xml,<svg width="16px" height="16px" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="%23000000"><path d="M1.5 14h11l.48-.37 2.63-7-.48-.63H14V3.5l-.5-.5H7.71l-.86-.85L6.5 2h-5l-.5.5v11l.5.5zM2 3h4.29l.86.85.35.15H13v2H8.5l-.35.15-.86.85H3.5l-.47.34-1 3.08L2 3zm10.13 10H2.19l1.67-5H7.5l.35-.15.86-.85h5.79l-2.37 6z"/></svg>');}
	.debugger .toolbar-button.-button_save { background-image: url('data:image/svg+xml,<svg width="16px" height="16px" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="%23000000"><path fill-rule="evenodd" clip-rule="evenodd" d="M13.353 1.146l1.5 1.5L15 3v11.5l-.5.5h-13l-.5-.5v-13l.5-.5H13l.353.146zM2 2v12h12V3.208L12.793 2H11v4H4V2H2zm6 0v3h2V2H8z"/></svg>');}

	.regs { cursor: default; }
	.regs .registers-table { border-collapse: collapse; }
	.regs .registers-table th, 
	.regs .registers-table td { padding: 0.05em 0.5em;  }
	.regs .registers-table th { background-color: #444444; color: #ffffff; font-weight: normal; }
	.regs .registers-table td { background-color: #eeeeee; padding-right: 0.75em; }
	.regs .registers-table td.-no-padding { padding: 0; }
	.regs .registers-table .-modified { background-color: #ffcccc; }
	.regs .registers-inner-table { width: 100%; border-collapse: collapse; }
	.regs .registers-inner-table td { padding-right: 0.5em; }

	.ports { cursor: default; }
	.ports .port-list { border-collapse: collapse; }
	.ports .port-item > * { padding: 0.05em 0.5em; }
	.ports .port-item > th { background-color: #444444; color: #ffffff; font-weight: normal; }
	.ports .port-item > td { padding-right: 0.75em; }
	.ports .filler > td { padding: 0.05em 0.5em; }

	.dasm { width: 300px; }
	.dasm .dasm-line { white-space: nowrap; cursor: default; }
	.dasm .dasm-line > * { padding: 0.05em 0.5em; display: inline-block; }
	.dasm .dasm-line > .addr { background-color: #444444; color: #ffffff;  }
	.dasm .dasm-line > .bytes { width: 80px; }
	.dasm .dasm-line > .mnemonics { padding-left: 1em; }
	.dasm .dasm-line.-pointer > .mnemonics { background: transparent url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAA8UlEQVQokXWSMU4DQQxFny0qjkCFEDRUEeIC2TZlityDA+wqe5sUlGl3b4CookgglIpjzKeYHZidHb40xdj+/t+WIcJJGLpr6vCszn2RNl4Y2ucKMUzPgeBZMEJ6wOzA2K3+UQ25xUzZAN0BR8busWKzatUxRbJ0gzgytE812yUxIAMpKd8CB4Z2lY3jucVACVPkwj1mr5Pt37raVov/FJD+XFWJ0lScHp9IW5r+lJc55cZs1v2CtKPp34r2flXM52CJ/I3ZhqY/ZyLpACqK0e4XZhvW+/OycbwgLxIB+MBsx3r/XsnNtj9XG9vakS8u7AfXLUyfEUTHWAAAAABJRU5ErkJggg==") no-repeat left center; }
	.dasm .dasm-line.-break-point > .mnemonics { background: transparent url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABw0lEQVQokV2SP08bQRDFf299RiGyqLBBQXcySJaBhi8RWZbo+Ap8CMqkT5UiSpU2HV16BAjJckfhdEG44GJsgSLb8r87blLcnXEy0mpnd2bfm5l9IjUHJJlPAk68mlZiee5qHGs0NqnXTwyOiaI9SUObTlvqds+5uGgbJC4DUY5gp6dVfP+L+X5TZi6lEsQxhGHIzc0Hu739rsFgJkg8ILFGY9MODr6ys9PU4yMGSMIACgUUBO8w+8x0+sxg8ANYOMDZ0dEJ29sNskdIICHnEGCzGba19Va7u2cEQdXAOQM0mRwrilyejHOYhGX78t73961UOgQ8D8DieE9xnJaXJf6/TIJicQOpYrDmZQMd5ixaZQHMuVcfFopjLJsoms9bJElajoRyFudQdjbn0NNTj/E4FCROkNDtnvPwELK+vuxLKwBIaDTCOp0r6/fvgEUB4OP9/W8rFv+oXH5PpVKUWfolOchoBNfXLV1efmI+/yWYKpcY5fIb6vWmarUzarV9S5INvbws6Pd7dDpX1m5/02Ty0+DZQbyUnKX9egRB1UqlQ0kV4hjG45B+/86iqAcMler0X62uCNwzWFsR+CIT9lLsfwFyZMUjvdOb3QAAAABJRU5ErkJggg==") no-repeat left center; }
	.dasm .dasm-line.-pointer.-break-point > .mnemonics { background: transparent url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAB3RJTUUH5wsCDQM1bwp8swAAAitJREFUKM9Nkj9oU2EUxX/3e++lTVILbWoM0rRNURCcKi5VQbBSKE5uCm4F0clF1KEQiji0uDgUl3YSxEVEutvWLLFDHWqKgq0tNWkMbZAk5N/78j6H/DEH7nLvPRfOuQeasGnjUzzggTJd1Zqo7pKupmemp4eW7l9entmtDsR+lQdFpGAqlaQcHLxnbW3TgNe64tkd0uzsGNHoUn9PYGbhUk2enz1PuO5DtL7C6OgdLCt+vLX1zuTzZQEswJSmpsLO5OQysdjMtsrLXKBOJlDhet7gdwVCoVP099/sKRS21eHhz3kwClC9ExO3iUSmTTYLYgDhrdXg2WiJnF9jqlVMOBywxsefMDIyZmiKR5XLt8R1lSgFRsA0ySuOZn64QC7ooSwLotELOhi8CNhNrY1GDK0REZCWX2JA4LWjmRv+y7HfA8fpF6XCBnxtqwsohekmtiECSPMo1C2tTfsNSK2WxPMQpQDTWQbhoWvzIhti0PUhJydZSqWMgKcE0Pv7H0inM/j9TZIxAMxqm/ifEGdqPqRYxKRSn00ut7cD2gY8e309aRwnjuO8IhIIIBXuasXC0WkGahaUiphEIimbmytF181lwLMAdRVkvFjcaeTz375MDN6I2Hbv4g9Lho5KdbW7myaRWG1sbLyslsvfg5A/B7oTOdPK7IPVp4v3Uunf1958LaA1lEoZcrk947pZoCDgCXgdg9p49PFxnwGfB30e9BkIpMBn/gccgH8BS+jjLMdqIQAAAABJRU5ErkJggg==") no-repeat left center; }
	.dasm .dasm-line.-cursor { background-color: #dfdfdf; }
	.dasm .dasm-line.-cursor > .addr { background-color: #7f7f7f; }
	.-focused .dasm .dasm-line.-cursor { background-color: #aaf7ff; }

	.watch { overflow-x: auto; }
	.watch .watch-list { border: 0; border-collapse: collapse; }
	.watch .watch-line { white-space: nowrap; cursor: default; }
	.watch .watch-line > * { padding: 0.05em 0.5em; }
	.watch .watch-line > .formula { background-color: #444444; color: #ffffff; width: 80px; text-align: right; }
	.watch .watch-line > .addr { background-color: #444444; color: #ffffff; }
	.watch .watch-line > .format { font-style: italic; }
	.watch .watch-line > .data { white-space: nowrap; padding-left: 0; padding-right: 0; }
	.watch .watch-line > .data > .mem-value { padding: 0 0.25em; margin: 0; }
	.watch .watch-line > .data > .mem-value.-modified { background-color: #ffcccc; }
	.watch .watch-line > .symbols { }
	.watch .watch-line.-cursor > * { background-color: #dfdfdf; }
	.watch .watch-line.-cursor > .formula,
	.watch .watch-line.-cursor > .addr { background-color: #7f7f7f; }
	.-focused .watch .watch-line.-cursor > * { background-color: #aaf7ff; }
	.-focused .watch .watch-line.-cursor > .formula,
	.-focused .watch .watch-line.-cursor > .addr { background-color: #7f7f7f; }

	.dump { cursor: default; }
	.dump .dump-data { border: 0; border-collapse: collapse; }
	.dump .dump-row > * { padding: 0.05em 0.5em; }
	.dump .dump-row > .addr { background-color: #444444; color: #ffffff; }
	.dump .dump-row > .data { white-space: nowrap; padding-left: 0; padding-right: 0; }
	.dump .dump-row > .data > .mem-value { padding: 0 0.25em; margin: 0; }
	.dump .dump-row > .data > .mem-value.-modified { background-color: #ffcccc; }
	.dump .dump-row > .symbols { }

</style>

<template id="debugger">
	<div class="debugger" data-bind="attr: { 'data-focus-context': CTX_DISASM }, commandDispatcher: commandDispatcher">
		<div class="debugger-row">
			<div class="debugger-block">
				<div class="header">CPU</div>
				<div class="regs" data-bind="with: registers">
					<table class="registers-table">
						<tr>
							<th>PC</th><td data-bind='hex16: pc, event: { dblclick: function () { pc.editing(true); } }'></td>
							<td class="-no-padding" rowspan="2" colspan="2">
								<table class="registers-inner-table">
									<tr>
										<th>R</th><td data-bind='hex8: r, event: { dblclick: function () { r.editing(true); } }'></td>
										<th>IFF</th><td data-bind='bit2: iff, event: { dblclick: function () { iff.editing(true); } }'></td>
									</tr>
									<tr>
										<th>I</th><td data-bind="hex8: i, event: { dblclick: function () { i.editing(true); } }"></td>
										<th>IMF</th><td data-bind='bit2: imf, event: { dblclick: function () { imf.editing(true); } }'></td>
									</tr>
								</table>
							</td>				
						</tr>
						<tr>
							<th>SP</th><td data-bind='hex16: sp, event: { dblclick: function () { sp.editing(true); } }'></td>
						</tr>
						<tr>
							<th>IX</th><td data-bind='hex16: ix, event: { dblclick: function () { ix.editing(true); } }'></td>
							<th>HL'</th><td data-bind='hex16: hl_, event: { dblclick: function () { hl_.editing(true); } }'></td>
						</tr>
						<tr>
							<th>IY</th><td data-bind='hex16: iy, event: { dblclick: function () { iy.editing(true); } }'></td>
							<th>DE'</th><td data-bind='hex16: de_, event: { dblclick: function () { de_.editing(true); } }'></td>
						</tr>
						<tr>
							<th>HL</th><td data-bind='hex16: hl, event: { dblclick: function () { hl.editing(true); } }'></td>
							<th>BC'</th><td data-bind='hex16: bc_, event: { dblclick: function () { bc_.editing(true); } }'></td>
						</tr>
						<tr>
							<th>DE</th><td data-bind='hex16: de, event: { dblclick: function () { de.editing(true); } }'></td>
							<th>AF'</th><td data-bind='hex16: af_, event: { dblclick: function () { af_.editing(true); } }'></td>
						</tr>
						<tr>
							<th>BC</th><td data-bind='hex16: bc, event: { dblclick: function () { bc.editing(true); } }'></td>
							<td class="-no-padding" rowspan="2" colspan="2">
								<table class="registers-inner-table">
									<tr>
										<th>S</th>
										<th>P</th>
										<th>Z</th>
										<th>N</th>
										<th>H</th>
										<th>C</th>
									</tr>
									<tr>
										<td data-bind='bit1: fs, event: { dblclick: function () { fs.editing(true); } }'></td>
										<td data-bind='bit1: fp, event: { dblclick: function () { fp.editing(true); } }'></td>
										<td data-bind='bit1: fz, event: { dblclick: function () { fz.editing(true); } }'></td>
										<td data-bind='bit1: fn, event: { dblclick: function () { fn.editing(true); } }'></td>
										<td data-bind='bit1: fh, event: { dblclick: function () { fh.editing(true); } }'></td>
										<td data-bind='bit1: fc, event: { dblclick: function () { fc.editing(true); } }'></td>
									</tr>
								</table>
							</td>
						</tr>
						<tr>
							<th>AF</th><td data-bind='hex16: af, event: { dblclick: function () { af.editing(true); } }'></td>
						</tr>
					</table>
				</div>
				<div class="toolbar">
					<button class="toolbar-button -button_load" title="Load state" data-bind="command: CMD_STATE_LOAD"></button><!--
				 --><button class="toolbar-button -button_save" title="Save state" data-bind="command: CMD_STATE_SAVE"></button><!--
				 --><span class="toolbar-separator"></span><!--
				 --><button class="toolbar-button -button_bdi-start-logging" title="BDI Start Logging" data-bind="command: CMD_BDI_START_LOGGING"></button><!--
				 --><button class="toolbar-button -button_bdi-stop-logging" title="BDI Stop Logging" data-bind="command: CMD_BDI_STOP_LOGGING"></button>
				</div>
			</div><!--
		 --><div class="debugger-block">
				<div class="header">MISC</div>
				<div class="ports">
					<table class="port-list">
						<tr class="port-item">
							<th>7FFD</th>
							<td data-bind="hex8: ports.port_7FFD, event: { dblclick: function () { ports.port_7FFD.editing(true); }}"></td>
						</tr>
						<tr class="port-item">
							<th>FE</th>
							<td data-bind="hex8: ports.port_FE, event: { dblclick: function () { ports.port_FE.editing(true); }}"></td>
						</tr>
						<tr class="port-item">
							<th>CMD/STS</th>
							<td>
								<span data-bind="hex8: betaDiskState().vg93.command"></span>/<span data-bind="hex8: betaDiskState().vg93.status"></span>
							</td>
						</tr>
						<tr class="port-item">
							<th>TR/SC</th>
							<td>
								<span data-bind="hex8: betaDiskState().vg93.track"></span>/<span data-bind="hex8: betaDiskState().vg93.sector"></span>
							</td>
						</tr>
						<tr class="port-item">
							<th>DATA</th>
							<td data-bind="hex8: betaDiskState().vg93.data"></td>
						</tr>
						<tr class="filler"><td colspan="2">&nbsp;</td></tr>
						<tr class="port-item">
							<th>MS</th>
							<td data-bind="text: ms().toFixed(3)"></td>
						</tr>
						<tr class="port-item">
							<th>TSTATES</th>
							<td data-bind="text: tstates"></td>
						</tr>
					</table>
				</div>
				<div class="toolbar">
				</div>				
		 	</div><!--
		 --><div class="debugger-block" data-bind="attr: { 'data-focus-context': CTX_DUMP }, css: { '-focused': commandDispatcher.context() == CTX_DUMP }, with: memory">
				<div class="header">DUMP: <span data-bind="editable: dump.formula, event: { dblclick: function () { dump.formula.editing(true); } }"></span></div>
				<div class="dump">
					<table class="dump-data" data-bind="foreach: dump">
						<tr class="dump-row">
						    <td class="addr" data-bind="text: DebugUtils.wordToString(addr())"></td><!--
						 --><td class="data" data-bind="foreach: data"><span class="mem-value" data-bind="hex8: $rawData, event: { dblclick: function () { $rawData.editing(true); } }"></span></td><!--
						 --><td class="symbols" data-bind="symbols: data"></td>
						</tr>
					</table>
				</div>
				<div class="toolbar">
					<button class="toolbar-button -button_prev-page" title="Previous page (PageUp)" data-bind="command: CMD_DUMP_PAGE_UP"></button><!--
				 --><button class="toolbar-button -button_prev" title="Previous (Left)" data-bind="command: CMD_DUMP_PREV"></button><!--
				 --><button class="toolbar-button -button_next" title="Next (Right)" data-bind="command: CMD_DUMP_NEXT"></button><!--
				 --><button class="toolbar-button -button_next-page" title="Next page (PageDown)" data-bind="command: CMD_DUMP_PAGE_DOWN"></button>
				</div>
			</div>
		</div>
		<div class="debugger-row">
			<div class="debugger-block" data-bind="attr: { 'data-focus-context': CTX_DISASM }, css: { '-focused': commandDispatcher.context() == CTX_DISASM }">
				<div class="header">INSTRUCTIONS</div>
				<div class="dasm" data-bind="with: disasm">
					<div class="dasm-block" data-bind="foreach: visibleRecords">
						<div class="dasm-line" data-bind="css: { '-cursor': $parent.cursorIndex() == ($parent.visibleIndex() + $index()), '-pointer': $parent.pointerIndex() == ($parent.visibleIndex() + $index()), '-break-point': $root.breakPoints.orderedSearch(addr) >= 0 }">
							<span class="addr" data-bind="text: DebugUtils.wordToString(addr)"></span><!--
						 --><span class="bytes" data-bind="text: DebugUtils.bytesToString(bytes)"></span><!--
						 --><span class="mnemonics" data-bind="text: $data.get_fullMnemonics()"></span>
						</div>
					</div>
					<div class="toolbar" data-bind="with: $root">
						<button class="toolbar-button" title="Run/Break (R)" data-bind="command: CMD_RUN_BREAK, css: { '-button_break': running(), '-button_run': !running() }"></button><!--
					 --><span class="toolbar-separator"></span><!--
					 --><button class="toolbar-button -button_step-over" title="Step over (O)" data-bind="command: CMD_STEP_OVER"></button><!--
					 --><button class="toolbar-button -button_step-in" title="Step in (P)" data-bind="command: CMD_STEP_IN"></button><!--
					 --><button class="toolbar-button -button_run-until-cursor" title="Run until cursor (I)" data-bind="command: CMD_RUN_UNTIL_CURSOR"></button><!--
					 --><button class="toolbar-button -button_run-until-address" title="Run until address (U)" data-bind="command: CMD_RUN_UNTIL_ADDRESS"></button><!--
					 --><span class="toolbar-separator"></span><!--
					 --><button class="toolbar-button -button_toggle-bp-at-cursor" title="Toggle break point at cursor (K)" data-bind="command: CMD_TOGGLE_BREAK_POINT_AT_CURSOR"></button><!--
					 --><button class="toolbar-button -button_toggle-bp-at-address" title="Toggle break point at address (J)" data-bind="command: CMD_TOGGLE_BREAK_POINT_AT_ADDRESS"></button>
					</div>
				</div>
			</div><!--
		 --><div class="debugger-block" data-bind="attr: { 'data-focus-context': CTX_WATCH }, css: { '-focused': commandDispatcher.context() == CTX_WATCH }">
				<div class="header">WATCH</div>
				<div class="watch" data-bind="with: memory">
					<table class="watch-list" data-bind="foreach: watchList">
						<tr class="watch-line" data-bind="css: { '-cursor': $parent.cursorIndex() == $index() }">
							<td class="formula" data-bind="editable: formula, event: { dblclick: function () { formula.editing(true); } }"></td><!--
						 --><td class="addr" data-bind="text: DebugUtils.wordToString(addr())"></td><!--
						 --><td class="format" data-bind="text: wordFormat() ? 'w' : 'b', click: function () { wordFormat(!wordFormat()); }"></td><!--
						 --><td class="data">
							<!-- ko if: wordFormat --><!-- ko foreach: data --><span class="mem-value" data-bind="hex16: $rawData, event: { dblclick: function () { $rawData.editing(true); } }"></span><!-- /ko --><!-- /ko -->
							<!-- ko ifnot: wordFormat --><!-- ko foreach: data --><span class="mem-value" data-bind="hex8: $rawData, event: { dblclick: function () { $rawData.editing(true); } }"></span><!-- /ko --><!-- /ko -->
							</td><!--
						 --><td class="symbols" data-bind="symbols: bytes"></td>
						</tr>
					</table>
					<div class="toolbar">
						<button class="toolbar-button -button_prev-page" title="Previous page (PageUp)" data-bind="command: CMD_WATCH_PAGE_UP"></button><!--
					 --><button class="toolbar-button -button_prev" title="Previous (Left)" data-bind="command: CMD_WATCH_PREV"></button><!--
					 --><button class="toolbar-button -button_next" title="Next (Right)" data-bind="command: CMD_WATCH_NEXT"></button><!--
					 --><button class="toolbar-button -button_next-page" title="Next page (PageDown)" data-bind="command: CMD_WATCH_PAGE_DOWN"></button>
					</div>
				</div>
			</div>
		</div>
	</div>
</template>

<script type="text/javascript">


	function ZX_Debug(container) {
		this.settings = ZXContext.settings;
		this.bus = ZXContext.hw.bus;
		this.cpu = ZXContext.hw.cpu;
		this.display = ZXContext.hw.display;
		this.clock = ZXContext.hw.clock;
		this.betadisk = ZXContext.hw.betadisk;

		this.running = ko.observable(false);
		this.breakPoints = ko.observableArray([]).extend({ ordered: true });
		this.breakRequest = ko.observable(false);
		this.state = ko.observable();
		this.ms = ko.observable(0);
		this.tstates = ko.observable(0);
		this.betaDiskState = ko.observable();

		$("<?=debugger?>").appendTo(container);
		this.disasm = new Dasm(this);
		this.registers = new DebugRegisters(this, function () { this.update(false); }.bind(this));
		this.ports = new DebugPorts(this, function () { this.update(false); }.bind(this));
		this.memory = new DebugMemory(this, function () { this.update(false); }.bind(this));

		this.commandDispatcher = new DebugCommandDispatcher(container);
		this.commandDispatcher.registerHandler([CMD_DASM_CURSOR_UP], this.disasm.cursorUp.bind(this.disasm));
		this.commandDispatcher.registerHandler([CMD_DASM_CURSOR_DOWN], this.disasm.cursorDown.bind(this.disasm));
		this.commandDispatcher.registerHandler([CMD_DASM_CURSOR_PAGE_UP], this.disasm.cursorPageUp.bind(this.disasm));
		this.commandDispatcher.registerHandler([CMD_DASM_CURSOR_PAGE_DOWN], this.disasm.cursorPageDown.bind(this.disasm));
		this.commandDispatcher.registerHandler([CMD_STEP_OVER], function () { this.stepOver();}.bind(this));
		this.commandDispatcher.registerHandler([CMD_STEP_IN], function () { this.stepIn(); }.bind(this));
		this.commandDispatcher.registerHandler([CMD_RUN_UNTIL_CURSOR], function () { this.runUntilCursor(); }.bind(this));
		this.commandDispatcher.registerHandler([CMD_RUN_UNTIL_ADDRESS], function () { this.runUntilAddress(); }.bind(this));
		this.commandDispatcher.registerHandler([CMD_RUN_BREAK], function () { this.toggleRunning(); }.bind(this));
		this.commandDispatcher.registerHandler([CMD_TOGGLE_BREAK_POINT_AT_CURSOR], function () { this.toggleBpAtCursor(); }.bind(this));
		this.commandDispatcher.registerHandler([CMD_TOGGLE_BREAK_POINT_AT_ADDRESS], function () { this.toggleBpAtAddress(); }.bind(this));
		this.commandDispatcher.registerHandler([CMD_WATCH_CURSOR_UP], function () { this.memory.cursorUp(); }.bind(this));
		this.commandDispatcher.registerHandler([CMD_WATCH_CURSOR_DOWN], function () { this.memory.cursorDown(); }.bind(this));
		this.commandDispatcher.registerHandler([CMD_WATCH_EDIT_FORMULA], function () { this.memory.editFormula(); }.bind(this));
		this.commandDispatcher.registerHandler([CMD_WATCH_PAGE_UP], function () { this.memory.watchPageUp(); }.bind(this));
		this.commandDispatcher.registerHandler([CMD_WATCH_PAGE_DOWN], function () { this.memory.watchPageDown(); }.bind(this));
		this.commandDispatcher.registerHandler([CMD_WATCH_PREV], function () { this.memory.watchPrev(); }.bind(this));
		this.commandDispatcher.registerHandler([CMD_WATCH_NEXT], function () { this.memory.watchNext(); }.bind(this));
		this.commandDispatcher.registerHandler([CMD_DUMP_PAGE_UP], function () { this.memory.dumpPageUp(); }.bind(this));
		this.commandDispatcher.registerHandler([CMD_DUMP_PAGE_DOWN], function () { this.memory.dumpPageDown(); }.bind(this));
		this.commandDispatcher.registerHandler([CMD_DUMP_PREV], function () { this.memory.dumpPrev(); }.bind(this));
		this.commandDispatcher.registerHandler([CMD_DUMP_NEXT], function () { this.memory.dumpNext(); }.bind(this));
		this.commandDispatcher.registerHandler([CMD_STATE_LOAD], function () { this.load(); }.bind(this));
		this.commandDispatcher.registerHandler([CMD_STATE_SAVE], function () { this.save(); }.bind(this));
		this.commandDispatcher.registerHandler([CMD_BDI_START_LOGGING], function () { this.bdiStartLogging(); }.bind(this));
		this.commandDispatcher.registerHandler([CMD_BDI_STOP_LOGGING], function () { this.bdiStopLogging(); }.bind(this));
		this.commandDispatcher.assignHotKey(0x26, [CTX_DISASM], CMD_DASM_CURSOR_UP);
		this.commandDispatcher.assignHotKey(0x28, [CTX_DISASM], CMD_DASM_CURSOR_DOWN);
		this.commandDispatcher.assignHotKey(0x21, [CTX_DISASM], CMD_DASM_CURSOR_PAGE_UP);
		this.commandDispatcher.assignHotKey(0x22, [CTX_DISASM], CMD_DASM_CURSOR_PAGE_DOWN);
		this.commandDispatcher.assignHotKey(0x4F, [CTX_DISASM, CTX_WATCH, CTX_DUMP], CMD_STEP_OVER);
		this.commandDispatcher.assignHotKey(0x50, [CTX_DISASM, CTX_WATCH, CTX_DUMP], CMD_STEP_IN);
		this.commandDispatcher.assignHotKey(0x49, [CTX_DISASM, CTX_WATCH, CTX_DUMP], CMD_RUN_UNTIL_CURSOR);
		this.commandDispatcher.assignHotKey(0x55, [CTX_DISASM, CTX_WATCH, CTX_DUMP], CMD_RUN_UNTIL_ADDRESS);
		this.commandDispatcher.assignHotKey(0x52, [CTX_DISASM, CTX_WATCH, CTX_DUMP], CMD_RUN_BREAK);
		this.commandDispatcher.assignHotKey(0x4B, [CTX_DISASM, CTX_WATCH, CTX_DUMP], CMD_TOGGLE_BREAK_POINT_AT_CURSOR);
		this.commandDispatcher.assignHotKey(0x4A, [CTX_DISASM, CTX_WATCH, CTX_DUMP], CMD_TOGGLE_BREAK_POINT_AT_ADDRESS);
		this.commandDispatcher.assignHotKey(0x26, [CTX_WATCH], CMD_WATCH_CURSOR_UP);
		this.commandDispatcher.assignHotKey(0x28, [CTX_WATCH], CMD_WATCH_CURSOR_DOWN);
		this.commandDispatcher.assignHotKey(0x0D, [CTX_WATCH], CMD_WATCH_EDIT_FORMULA);
		this.commandDispatcher.assignHotKey(0x21, [CTX_WATCH], CMD_WATCH_PAGE_UP);
		this.commandDispatcher.assignHotKey(0x22, [CTX_WATCH], CMD_WATCH_PAGE_DOWN);
		this.commandDispatcher.assignHotKey(0x25, [CTX_WATCH], CMD_WATCH_PREV);
		this.commandDispatcher.assignHotKey(0x27, [CTX_WATCH], CMD_WATCH_NEXT);
		this.commandDispatcher.assignHotKey(0x21, [CTX_DUMP], CMD_DUMP_PAGE_UP);
		this.commandDispatcher.assignHotKey(0x22, [CTX_DUMP], CMD_DUMP_PAGE_DOWN);
		this.commandDispatcher.assignHotKey(0x25, [CTX_DUMP], CMD_DUMP_PREV);
		this.commandDispatcher.assignHotKey(0x27, [CTX_DUMP], CMD_DUMP_NEXT);

		this.update = function (calcModification) {
			this.state(this.cpu.get_state());
			this.ms(this.clock.get_ms());
			this.tstates(this.clock.get_tstates());
			this.betaDiskState(this.betadisk.get_state());
			this.disasm.update();
			this.registers.update(calcModification);
			this.ports.update(calcModification);
			this.memory.update(calcModification);
		}

		this.commandDispatcher.enable([
			CMD_DASM_CURSOR_UP, CMD_DASM_CURSOR_DOWN, CMD_DASM_CURSOR_PAGE_UP, CMD_DASM_CURSOR_PAGE_DOWN,
			CMD_STEP_OVER, CMD_STEP_IN, CMD_RUN_UNTIL_CURSOR, CMD_RUN_UNTIL_ADDRESS, CMD_RUN_BREAK,
			CMD_TOGGLE_BREAK_POINT_AT_CURSOR, CMD_TOGGLE_BREAK_POINT_AT_ADDRESS, CMD_WATCH_CURSOR_UP,
			CMD_WATCH_CURSOR_DOWN, CMD_WATCH_EDIT_FORMULA, CMD_WATCH_PAGE_UP, CMD_WATCH_PAGE_DOWN,
			CMD_DUMP_PAGE_UP, CMD_DUMP_PAGE_DOWN, CMD_WATCH_PREV, CMD_WATCH_NEXT, CMD_DUMP_PREV, CMD_DUMP_NEXT,
			CMD_STATE_LOAD, CMD_STATE_SAVE, CMD_BDI_START_LOGGING, CMD_BDI_STOP_LOGGING
		]);

		this.update(true);
		ko.applyBindings(this, container);

		this.toggleRunning = function () {
			if ( this.running() ) {
				this.breakRequest(true);
			}
			else {
				this.run([]);
			}
		}

		this.stepIn = function() {
			var cmd = DasmRecord.read(this.bus, this.state().pc);
			if ( /^(JP|JR|DJNZ|CALL|RST)/.test(cmd.mn) ) {
				// прыжки и вызовы могут передать управление по заданному адресу
				if ( cmd.operands.addr !== undefined ) {
					this.run([cmd.get_next(), cmd.operands.addr]);
				}
				else {
					var addr;
					if ( /HL/.test(cmd.mn) ) {
						addr = this.state().hl;
					}
					else if ( /IX/.test(cmd.mn) ) {
						addr = this.state().ix;
					}
					else if ( /IY/.test(cmd.mn) ) {
						addr = this.state().iy;
					}
					else {
						throw Error('Unknown control command');
					}

					this.run([cmd.get_next(), addr]);
				}
			}
			else if ( /^RET/.test(cmd.mn) ) {
				// команды RET... могут передать управление как следующей команде, так и по адресу в стеке
                var addr = this.bus.mem_read(this.state().sp) | (this.bus.mem_read((this.state().sp + 1) & 0xFFFF) << 8);
				this.run([cmd.get_next(), addr]);
			}
			else if ( /^(HALT|(LD|CP|IN|OT)[ID]R)/.test(cmd.mn) ) {
				// блочные команды и команда HALT могут откинуть PC на начало команды
				this.run([cmd.get_next(), this.state().pc]);
			}
			else {
				this.run([cmd.get_next()]);
			}
		}

		this.stepOver = function () {
			var cmd = DasmRecord.read(this.bus, this.state().pc);
			if ( /^(JP|JR|DJNZ)/.test(cmd.mn) ) {
				if ( cmd.operands.addr !== undefined ) {
					this.run([cmd.get_next(), cmd.operands.addr]);
				}
				else {
					var addr;
					if ( /HL/.test(cmd.mn) )
						addr = this.state().hl;
					else if ( /IX/.test(cmd.mn) )
						addr = this.state().ix;
					else if ( /IY/.test(cmd.mn) )
						addr = this.state().iy;
					else
						throw Error('Unknown control command');

					this.run([cmd.get_next(), addr]);
				}
			}
			else if ( /^RET/.test(cmd.mn) ) {
                var addr = this.bus.mem_read(this.state().sp) | (this.bus.mem_read((this.state().sp + 1) & 0xFFFF) << 8);
				this.run([cmd.get_next(), addr]);
			}
			else {
				this.run([cmd.get_next()]);
			}
		}

		this.runUntilCursor = function () {
			var record = this.disasm.records()[this.disasm.cursorIndex()];
			this.run([record.addr]);
		}

		this.runUntilAddress = function () {
			var addrStr = prompt('Введите адрес назначения (HEX):', '');
			if (!addrStr)
				return;
			var addr = parseInt(addrStr, 16);
			if (isNaN(addr))
				return;
			this.run([addr]);
		}

		this.toggleBpAtCursor = function () {
			var record = this.disasm.records()[this.disasm.cursorIndex()];
			if (record) {
				this.toggleBp(record.addr);
			}
		}

		this.toggleBpAtAddress = function () {
			var addrStr = prompt('Введите адрес назначения (HEX):', '');
			if (!addrStr)
				return;
			var addr = parseInt(addrStr, 16);
			if (isNaN(addr))
				return;
			this.toggleBp(addr);
		}

		this.toggleBp = function (address) {
			var bpIndex = this.breakPoints.orderedSearch(address);
			if (bpIndex < 0) {
				this.breakPoints.orderedInsert(address);
			}
			else {
				this.breakPoints.splice(bpIndex, 1);
			}
		}

		this.run = function (untilAddresses) {
			untilAddresses = untilAddresses || [];
			var firstInstruction = true;
			this.running(true);
			this.disasm.pointerIndex(-1);
			this.disasm.cursorIndex(-1);

			this.commandDispatcher.disable([
				CMD_DASM_CURSOR_UP, CMD_DASM_CURSOR_DOWN, CMD_DASM_CURSOR_PAGE_UP, CMD_DASM_CURSOR_PAGE_DOWN,
				CMD_STEP_IN, CMD_STEP_OVER, CMD_RUN_UNTIL_CURSOR, CMD_RUN_UNTIL_ADDRESS, CMD_WATCH_CURSOR_UP,
				CMD_WATCH_CURSOR_DOWN, CMD_WATCH_EDIT_FORMULA, CMD_WATCH_PAGE_UP, CMD_WATCH_PAGE_DOWN,
				CMD_DUMP_PAGE_UP, CMD_DUMP_PAGE_UP, CMD_WATCH_PREV, CMD_WATCH_NEXT, CMD_DUMP_PREV, CMD_DUMP_NEXT,
				CMD_STATE_LOAD, CMD_STATE_SAVE
			]);

			this.clock.runDebug(
				function (state) {
					if (firstInstruction) {
						firstInstruction = false;
						return false;
					}
					return untilAddresses.indexOf(state.pc) >= 0 || this.breakPoints.orderedSearch(state.pc) >= 0 || this.breakRequest();
				}.bind(this),
				function () {
					this.display.force_redraw();
					this.commandDispatcher.enable([
						CMD_DASM_CURSOR_UP, CMD_DASM_CURSOR_DOWN, CMD_DASM_CURSOR_PAGE_UP, CMD_DASM_CURSOR_PAGE_DOWN,
						CMD_STEP_IN, CMD_STEP_OVER, CMD_RUN_UNTIL_CURSOR, CMD_RUN_UNTIL_ADDRESS, CMD_WATCH_CURSOR_UP,
						CMD_WATCH_CURSOR_DOWN, CMD_WATCH_EDIT_FORMULA, CMD_WATCH_PAGE_UP, CMD_WATCH_PAGE_DOWN,
						CMD_DUMP_PAGE_UP, CMD_DUMP_PAGE_UP, CMD_WATCH_PREV, CMD_WATCH_NEXT, CMD_DUMP_PREV, CMD_DUMP_NEXT,
						CMD_STATE_LOAD, CMD_STATE_SAVE
					]);

					this.update(true);
					this.running(false);
					this.breakRequest(false);
				}.bind(this));
		}

		this.load = function () {
			var $input = $('<input type="file" accept=".json" style="visibility: hidden;" />').appendTo(document.body);
			$input.on('change', function (e) {
				var filename = $input.val();
				if (!filename)
					return;
				loadLocalFile($input[0]).then(function (data) {
					var chars = new Array(data.length);
					for (var i = 0; i < data.length; i++) {
						chars[i] = String.fromCharCode(data[i]);
					}
					return chars.join('');
				}).then(function (debugStateJson) {
					var debugState = JSON.parse(debugStateJson);
					for ( var i = 0; i < 8; i++ ) {
						this.bus.var_write('port_7ffd_value', i);
						var data = debugState.memory[i];
						for ( var addr = 0xC000, dataIndex = 0; addr <= 0xFFFF; addr++, dataIndex++ ) {
							this.bus.mem_write(addr, data[dataIndex]);
						}
					}
					this.bus.var_write('port_7ffd_value', debugState.io['7ffd']);
					this.bus.var_write('port_fe_value', debugState.io['fe']);
					this.bus.var_write('rom_trdos', debugState.rom['trdos']);
					this.bus.var_write('rom_turbo', debugState.rom['turbo']);
					this.cpu.set_state(debugState.cpu);
					this.breakPoints([]);
					for (var i = 0; i < debugState.breakPoints.length; i++) {
						this.breakPoints.orderedInsert(debugState.breakPoints[i]);
					}
					this.update(true);
				}.bind(this)).then(function () {
					$input.remove();
				});
			}.bind(this));
			$input.click();
		}

		this.save = function () {
			var _7ffd = this.bus.var_read('port_7ffd_value');
			var _fe = this.bus.var_read('port_fe_value');
			var debugState = {
				cpu: this.cpu.get_state(),
				io: { '7ffd': _7ffd, 'fe': _fe },
				rom: { 
					'trdos': this.bus.var_read('rom_trdos'),
					'turbo': this.bus.var_read('rom_turbo')
				},
				memory: [],
				breakPoints: this.breakPoints()
			};
			for ( var i = 0; i < 8; i++ ) {
				this.bus.var_write('port_7ffd_value', i);
				var data = new Array(0x4000);
				for ( var addr = 0xC000, dataIndex = 0; addr <= 0xFFFF; addr++, dataIndex++ ) {
					data[dataIndex] = this.bus.mem_read(addr);
				}
				debugState.memory.push(data);
			}
			this.bus.var_write('port_7ffd_value', _7ffd);
			downloadText(JSON.stringify(debugState), 'zx-state-' + Date.now() + '.json')
		}

		this.bdiStartLogging = function () {
			ZXContext.hw.betadisk.startLogging();
		}

		this.bdiStopLogging = function () {
			var log = ZXContext.hw.betadisk.stopLogging();
			if (log) {
				var logLines = this.translateBdiLog(log).join('\n');
				downloadText(logLines, 'bdi_trace_' + Date.now() + '.txt');
			}
		}

		this.translateBdiLog = function (log) {
			var records = new Array(log.length);
			for ( var i = 0; i < log.length; i++ ) {
				records[i] = this.translateBdiLogRecord(log[i]);
			}
			return records;
		}

		this.translateBdiLogRecord = function(data) {
			var chunks = [];
			chunks.push(('00000000' + data.ts.toFixed(3)).substr(-12) + ': ');
			chunks.push(DebugUtils.byteToString(data.value));
			switch (data.op) {
				case 'i': chunks.push('<-'); break;
				case 'o': chunks.push('->'); break;
			}
			chunks.push('(' + DebugUtils.byteToString(data.port) + ')');
			if (data.op == 'i') {
				switch (data.port) {
					case 0x1F: chunks.push('Get Status (' + DebugUtils.byteToString(data.value) + ')'); break;
					case 0x3F: chunks.push('Get Track (' + DebugUtils.byteToString(data.value) + ')'); break;
					case 0x5F: chunks.push('Get Sector (' + DebugUtils.byteToString(data.value) + ')'); break;
					case 0x7F: chunks.push('Get Data (' + DebugUtils.byteToString(data.value) + ')'); break;
					case 0xFF: chunks.push('Get System Register (INTRQ=' + +!!(data.value & 0x80) + ', DRQ=' + +!!(data.value & 0x40) + ')'); break;
				}
			}
			else {
				switch (data.port) {
					case 0x1F:
						if ((data.value & 0xE0) == 0x00) {
							chunks.push(((data.value & 0x10) ? 'Seek' : 'Restore') + ' (HLD=' + +!!(data.value & 0x08) + ', VERIFY=' + +!!(data.value & 0x04) + ', RATE=' + (data.value & 0x03) + ')');
						}
						else if (!(data.value & 0x80)) {
							var cmd;
							switch (data.value & 0x60) {
								case 0x20: cmd = 'Step'; break;
								case 0x40: cmd = 'Step In'; break;
								case 0x60: cmd = 'Step Out'; break;
							}
							chunks.push(cmd + ' (UPDATE=' + +!!(data.value & 0x10) + ', HLD=' + +!!(data.value & 0x08) + ', VERIFY=' + +!!(data.value & 0x04) + ', RATE=' + (data.value & 0x03) + ')');
						}
						else if ((data.value & 0xE0) == 0x80) {
							chunks.push('Read Sector (MULTIPLE=' + +!!(data.value & 0x10) + ', HEAD=' + +!!(data.value & 0x08) + ', ENGAGE=' + +!!(data.value & 0x04) + ', HCHK=' + +!!(data.value & 0x02) + ')');
						}
						else if ((data.value & 0xE0) == 0xA0) {
							chunks.push('Write Sector (MULTIPLE=' + +!!(data.value & 0x10) + ', HEAD=' + +!!(data.value & 0x08) + ', ENGAGE=' + +!!(data.value & 0x04) + ', HCHK=' + +!!(data.value & 0x02) + ', TYPE=' + +!!(data.value & 0x01) + ')');
						}
						else if ((data.value & 0xF0) != 0xD0) {
							var cmd;
							switch (data.value & 0xF0) {
								case 0xC0: cmd = 'Read Address'; break;
								case 0xE0: cmd = 'Read Track'; break;
								case 0xF0: cmd = 'Write Track'; break
							}
							chunks.push(cmd + ' (ENGAGE=' + +!!(data.value & 0x04) + ')');
						}
						else {
							chunks.push('Force Interrupt (Immediate=' + +!!(data.value & 0x08) + ', IndexPulse=' + +!!(data.value & 0x04) + ', Unready=' + +!!(data.value & 0x02) + ', Ready=' + +!!(data.value & 0x01) + ')');
						}
						break;
					case 0x3F: chunks.push('Set Track (' + DebugUtils.byteToString(data.value) + ')'); break;
					case 0x5F: chunks.push('Set Sector (' + DebugUtils.byteToString(data.value) + ')'); break;
					case 0x7F: chunks.push('Set Data (' + DebugUtils.byteToString(data.value) + ')'); break;
					case 0xFF: chunks.push('Set System Register (DDEN=' + +!(data.value & 0x40) + ', HEAD=' + +!(data.value & 0x10) + ', HLT=' + +!!(data.value & 0x08) + ', RESET=' + +!(data.value & 0x04) + ', DRIVE=' + (data.value & 0x03) + ')'); break;
				}
			}
			return chunks.join('\t');
		}
	}
</script>