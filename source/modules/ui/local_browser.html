<style>
.ui-dialog .local-browser { border-radius: 0 0 10px 10px; -moz-border-radius: 0 0 10px 10px; -webkit-border-radius: 0 0 10px 10px; padding: 1em 0.5em; }
</style>

<template id="local-browser">
	<div class="local-browser">
		<input type="file" name="image" />
	</div>
</template>

<script type="text/javascript">
	function LocalBrowser() {
		'use strict';

		var $dlg = $("<?=local-browser?>");
		var openResult$ = null;

		this.open = open;

		function open() {
			if (!openResult$) {
				openResult$ = $.Deferred();
				init();
			}
			return openResult$;
		}

		function init() {
			$dlg.dialog({
				autoOpen: true,
				title: 'Выберите образ TRD, FDI или SCL',
				modal: true,
				width: 400,
				height: 120,
				close: function (e) { 
					$(this).dialog('destroy'); 
					$(this).remove(); 

					if (openResult$) {
						openResult$.reject();
						openResult$ = null;
					}
				}
			});
			$dlg.on('keydown', function(e) { e.stopPropagation(); });
			$dlg.on('keyup', function(e) { e.stopPropagation(); });		

			var $image = $dlg.find('[name=image]');
			$image.on('change', function (e) {
				if (openResult$) {
					openResult$.resolve(e.target);
					openResult$ = null;
				}
				$dlg.dialog('close');
				$dlg = null;
			});
		}
	}
</script>