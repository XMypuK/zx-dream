<style>
	.settings-dialog__menu {
		float: left;
		width: 120px;
		height: 100%;
	}
	.settings-dialog__workspace {
		margin-left: 120px;
		overflow-x: hidden;
		overflow-y: auto;
	}

	.settings-dialog .settings-menu { border-right: 2px solid #3D8AF7; }
	.settings-dialog .settings-menu__section { display: block; cursor: pointer; padding: 0.2em 0.5em; }
	.settings-dialog .settings-menu__section.-active { background-color: #3D8AF7; color: #FFFFFF; }
	.settings-dialog .settings-section { display: none; }
	.settings-dialog .settings-section.-active { display: block; }
	.settings-dialog .settings { padding: 0 0.5em; }

	.settings-dialog table {
		width: 100%;
	}

	.settings-dialog tr th {
		text-align: left;
		font-weight: normal;
	}

	.settings-dialog input[type=text] {
		width: 80px;
		text-align: center;
	}

	.ui-dialog .ui-dialog-buttonpane .ui-dialog-buttonset .reset-settings-button {
		position: absolute;
		left: 15px;
	}
</style>

<template id="settings-dialog">
	<div class="settings-dialog">
		<div class="settings-dialog__menu settings-menu" data-bind="foreach: sectionOptions">
			<a class="settings-menu__section" data-bind="attr: { 'data-section': value }, css: { '-active': value == $parent.activeSection() }, text: text, click: $parent.onSectionClick"></a>
		</div>
		<div class="settings-dialog__workspace settings">
			<div class="settings__section settings-section" data-bind="css: { '-active': activeSection() == 'bus' }">
				<table>
					<tr>
						<th>Тактов за прерывание (норма):</th>
						<td><input type="text" data-bind="value: tstatesPerIntrq" /></td>
					</tr>
					<tr>
						<th>Тактов за прерывание (турбо):</th>
						<td><input type="text" data-bind="value: tstatesPerIntrqTurbo" /></td>
					</tr>
					<tr>
						<th>Период прерываний (мс):</th>
						<td><input type="text" data-bind="value: intrqPeriod" /></td>
					</tr>
					<tr>
						<th>Турбо-режим:</th>
						<td><input type="checkbox" data-bind="checked: turboMode" /></td>
					</tr>
				</table>
			</div>
			<div class="settings__section settings-section" data-bind="css: { '-active': activeSection() == 'memory' }">
				<table>
					<tr>
						<th>Расширенная память:</th>
						<td>
							<select data-bind="options: extendedMemoryOptions, optionsValue: 'value', optionsText: 'text', value: extendedMemory"></select>
						</td>
					</tr>
				</table>
			</div>
			<div class="settings__section settings-section" data-bind="css: { '-active': activeSection() == 'display' }">
				<table>
					<tr>
						<th>Включить полутона:</th>
						<td><input type="checkbox" data-bind="checked: semicolors" /></td>
					</tr>
					<tr>
						<th>Отрисовка:</th>
						<td><select data-bind="options: renderTypeOptions, optionsValue: 'value', optionsText: 'text', value: rendererType"></select></td>
					</tr>
					<tr>
						<th>Метод масштабирования:</th>
						<td><select data-bind="options: scaleTypeOptions, optionsValue: 'value', optionsText: 'text', value: scaleType"></select></td>
					</tr>			
					<tr>
						<th>Масштаб:</th>
						<td><select data-bind="options: scaleValueOptions, optionsValue: 'value', optionsText: 'text', value: scaleValue"></select></td>
					</tr>
					<tr>
						<th>Отрисовка по событию кадра анимации</th>
						<td><input type="checkbox" data-bind="checked: renderOnAnimationFrame" /></td>
					</tr>
				</table>
			</div>
			<div class="settings__section settings-section" data-bind="css: { '-active': activeSection() == 'audio' }">
				<table>
					<tr>
						<th>Музыкальный сопроцессор</th>
						<td><select data-bind="options: psgOptions, optionsValue: 'value', optionsText: 'text', value: psg"></select></td>
					</tr>
					<tr>
						<th>Тактовая частота муз.сопроцессора</th>
						<td><select data-bind="options: psgClockOptions, optionsValue: 'value', optionsText: 'text', value: psgClock"></select></td>
					</tr>
					<tr>
						<th>Размер выходного буфера</th>
						<td><select data-bind="options: psgBufferSizeOptions, optionsValue: 'value', optionsText: 'text', value: psgBufferSize"></select></td>
					</tr>
				</table>
			</div>
			<div class="settings__section settings-section" data-bind="css: { '-active': activeSection() == 'misc' }">
				<table>
				</table>
			</div>
		</div>
	</div>
</template>

<script type="text/javascript">
	function SettingsKoModel() {
		this.semicolors = ko.observable(ZXContext.settings.get_semicolors());
		this.renderTypeOptions = ko.pureComputed(function () {
			var result = [
				{ value: VAL_RENDERER_PUT_IMAGE_DATA, text: 'метод putImageData' },
				{ value: VAL_RENDERER_DRAW_IMAGE, text: 'метод drawImage' }
			];
			if (isWebGLSupported()) {
				result.push({ value: VAL_RENDERER_WEB_GL, text: 'WebGL' });
			}
			return result;
		}, this);
		this.rendererType = ko.observable(ZXContext.settings.get_rendererType());
		this.scaleTypeOptions = ko.pureComputed(function () {
			var result = [];
			result.push({ value: VAL_SCALE_METHOD_PRE, text: 'Предварительное' });
			if ( this.rendererType() != VAL_RENDERER_PUT_IMAGE_DATA ) { 
				result.push({ value: VAL_SCALE_METHOD_RENDER, text: 'При отрисовке' }); 
			}
			result.push({ value: VAL_SCALE_METHOD_POST, text: 'Последующее' });
			return result;
		}, this);
		this.scaleType = ko.observable(ZXContext.settings.get_scaleType());
		this.scaleValueOptions = ko.pureComputed(function () {
			var useFractionalValues = !(
				( this.scaleType() == VAL_SCALE_METHOD_PRE ) 
				|| ( this.rendererType() == VAL_RENDERER_WEB_GL && this.scaleType() == VAL_SCALE_METHOD_RENDER ));

			var result = [];
			result.push({ value: 1.0, text: '100%' });
			if ( useFractionalValues ) { result.push({ value: 1.5, text: '150%' }); }
			result.push({ value: 2.0, text: '200%' });
			if ( useFractionalValues ) { result.push({ value: 2.5, text: '250%' }); }
			result.push({ value: 3.0, text: '300%' });
			if ( useFractionalValues ) { result.push({ value: 3.5, text: '350%' }); }
			result.push({ value: 4.0, text: '400%' });
			return result;			
		}, this);
		this.scaleValue = ko.observable(ZXContext.settings.get_scaleValue());
		this.tstatesPerIntrq = ko.observable(ZXContext.settings.get_tstatesPerIntrq()).extend({ numeric: 0 });
		this.tstatesPerIntrqTurbo = ko.observable(ZXContext.settings.get_tstatesPerIntrqTurbo()).extend({ numeric: 0 });
		this.turboMode = ko.observable(ZXContext.settings.get_turboMode());
		this.intrqPeriod = ko.observable(ZXContext.settings.get_intrqPeriod()).extend({ numeric: 3 });
		this.extendedMemoryOptions = ko.observableArray([
			{ value: VAL_EXTENDED_MEMORY_OFF, text: 'выключена' },
			{ value: VAL_EXTENDED_MEMORY_PENTAGON, text: 'Pentagon 512 КБ' }
		]);
		this.extendedMemory = ko.observable(ZXContext.settings.get_extendedMemory());
		this.psgOptions = ko.observableArray([
			{ value: VAL_PSG_OFF, text: 'выключен' },
			{ value: VAL_PSG_AY_3_891X, text: 'AY-3-891x' },
			{ value: VAL_PSG_YM_2149, text: 'YM2149' }
		]);
		this.psg = ko.observable(ZXContext.settings.get_psg());
		this.psgClockOptions = ko.observableArray([
			{ value: 1773400, text: '1.7734 МГц (ZX-Spectrum 128K)' },
			{ value: 1750000, text: '1.75 МГц (Pentagon)' },
			{ value: 1764000, text: '1.764 МГц (TS 2068)' },
			{ value: 1638190, text: '1.63819 МГц (Fuller Box)' }
		]);
		this.psgClock = ko.observable(ZXContext.settings.get_psgClock());
		this.psgBufferSizeOptions = ko.observableArray([
			{ value: 0, text: 'автоматически' },
			{ value: 256, text: '256 сэмплов' },
			{ value: 512, text: '512 сэмплов' },
			{ value: 1024, text: '1024 сэмплов' },
			{ value: 2048, text: '2048 сэмплов' },
			{ value: 4096, text: '4096 сэмплов' },
			{ value: 8192, text: '8192 сэмплов' },
			{ value: 16384, text: '16384 сэмплов' }
		]);
		this.psgBufferSize = ko.observable(ZXContext.settings.get_psgBufferSize());
		this.renderOnAnimationFrame = ko.observable(ZXContext.settings.get_renderOnAnimationFrame());

		this.scaleTypeOptions.subscribe(function (options) {
			if ($.grep(options, function (opt) { return opt.value == this.scaleType(); }.bind(this)) == 0) {
				this.scaleType(options[0].value);
			}
		}, this);

		this.scaleValueOptions.subscribe(function (options) {
			if ($.grep(options, function (opt) { return opt.value == this.scaleValue(); }.bind(this)) == 0) {
				this.scaleValue(options[0].value);
			}
		}, this);

		this.sectionOptions = ko.observableArray([
			{ value: 'bus', text: 'Шина' },
			{ value: 'memory', text: 'Память' },
			{ value: 'display', text: 'Дисплей' },
			{ value: 'audio', text: 'Звук' }/*,
			{ value: 'misc', text: 'Другое' }*/
		]);
		this.activeSection = ko.observable('bus');
		this.onSectionClick = function (section) {
			this.activeSection(section.value);
		}.bind(this);
	}

	function SettingsDialog() {
		var $dlg = $("<?=settings-dialog?>");
		var openResult$ = null;
		var openResult$resolve = null;
		var openResult$reject = null;
		var model;

		this.open = open;

		function open() {
			if (!openResult$) {
				openResult$ = new Promise(function (resolve, reject) {
					openResult$resolve = resolve;
					openResult$reject = reject;
				});
				init();
			}
			return openResult$;
		}

		function init() {
			$dlg.dialog({
				autoOpen: true,
				title: 'Настройки',
				modal: true,
				width: 600,
				height: 440,
				buttons: [
					{ text: 'Сбросить все настройки', click: reset, "class": 'reset-settings-button' },
					{ text: 'Применить', click: apply },
					{ text: 'Отмена', click: cancel }
				],
				close: function (e) { 
					$(this).dialog('destroy'); 
					$(this).remove(); 

					if (openResult$) {
						openResult$resolve();
						openResult$ = null;
					}
				}
			});
			$dlg.on('keydown', function (e) { e.stopPropagation(); });
			$dlg.on('keyup', function (e) { e.stopPropagation(); });

			model = new SettingsKoModel();
			ko.applyBindings(model, $dlg[0]);
		}
		

		function apply() {
			ZXContext.settings.set_tstatesPerIntrq(+model.tstatesPerIntrq() || ZX_Settings.defaultValues.tstatesPerIntrq);
			ZXContext.settings.set_tstatesPerIntrqTurbo(+model.tstatesPerIntrqTurbo() || ZX_Settings.defaultValues.tstatesPerIntrqTurbo);
			ZXContext.settings.set_intrqPeriod(+model.intrqPeriod() || ZX_Settings.defaultValues.intrqPeriod);
			ZXContext.settings.set_turboMode(model.turboMode());
			ZXContext.settings.set_extendedMemory(+model.extendedMemory());
			ZXContext.settings.set_semicolors(model.semicolors());
			ZXContext.settings.set_rendererType(+model.rendererType() || ZX_Settings.defaultValues.rendererType);
			ZXContext.settings.set_scaleType(+model.scaleType() || ZX_Settings.defaultValues.scaleType);
			ZXContext.settings.set_scaleValue(+model.scaleValue() || ZX_Settings.defaultValues.scaleValue);
			ZXContext.settings.set_renderOnAnimationFrame(model.renderOnAnimationFrame());
			ZXContext.settings.set_psg(+model.psg());
			ZXContext.settings.set_psgClock(+model.psgClock() || ZX_Settings.defaultValues.psgClock);
			ZXContext.settings.set_psgBufferSize(+model.psgBufferSize());

			if (openResult$) {
				openResult$resolve(true);
				openResult$ = null;
			}

			$dlg.dialog('close');
			$dlg = null;
		}

		function cancel() {
			if (openResult$) {
				openResult$resolve();
				openResult$ = null;
			}			
			$dlg.dialog('close');
			$dlg = null;
		}

		function reset() {
			ZXContext.settings.reset();
			if (openResult$) {
				openResult$resolve(true);
				openResult$ = null;
			}
			$dlg.dialog('close');
			$dlg = null;
		}
	}
</script>