<include source="drive_dispatcher.html" includeType="embed" />
<include source="settings_dialog.html" includeType="embed" />
<include source="create_image_dialog.html" includeType="embed" />
<include source="save_image_dialog.html" includeType="embed" />
<include source="server_browser.html" includeType="embed" />
<include source="pc_keyboard.js" includeType="embed" />
<include source="virtual_display.js" includeType="embed" />
<include source="virtual_keyboard.html" includeType="embed" />
<include source="virtual_mouse.html" includeType="embed" />
<include source="about_dialog.html" includeType="embed" />

<style type="text/css">
	body {
		width: 100%;
		margin: 8px 0;
	}

	.clear {
		clear: both;
	}

	#main_container {
		margin: 0 auto;
	}

	#left_field,
	#right_field {
		width: 250px;
	}

	#left_field,
	#right_field,
	#center_field {
		float: left;
	}

	#commands {
		margin: 200px 0 10px 0;
	}
	#commands a {
		margin: 0;
	}
	#display {
		position: relative;
		border: 1px solid #a0a0a0;
		border-radius: 5px;
		box-shadow: 1px 1px #a0a0a0;
		width: 576px;
		height: 448px;
		margin: 0 auto;
	}

	#display .error-message {
		text-align: center;
		color: #ff0000;
		padding: 2em;
	}

	#vkeyb {
		margin: 5px auto;
		text-align: center;
	}
	#vmouse {
		margin: 200px 10px 10px 10px;
		text-align: center;
	}

	#debug {
		display: none;
		width: 970px;
	}
</style>

<template id="workspace">
	<div id="main_container">
		<div id="left_field">
			<div id="commands">
				<a data-command="reset" title="Сброс"><img src="img/reset.png" alt="Сброс" /></a><!--
			 --><a data-command="settings" title="Настройки"><img src="img/properties.png" alt="Настройки"/></a><!--
			 --><a data-command="snapshot-open" title="Загрузить снимок"><img src="img/open.png" alt="Загрузить снимок" /></a><!--
			 --><a data-command="snapshot-save" title="Сохранить снимок"><img src="img/save.png" alt="Сохранить снимок" /></a><!--
             --><a data-command="about" title="Об эмуляторе"><img src="img/info.png" alt="Об эмуляторе"/></a>
			</div>
			<div id="drives"></div>	
		</div>
		<div id="center_field">
			<div id="display"></div>
			<div id="vkeyb"></div>		
		</div>	
		<div id="right_field">
			<div id="vmouse"></div>
		</div>
		<div class="clear"></div>
		<div id="debug_container">
			<div id="debug"></div>
		</div>
	</div>
</template>

<script type="text/javascript">
    function ZX_Workspace() {
        var $workspace = $("<?=workspace?>");
        var $display = $workspace.find('#display');
        var $vkeyb = $workspace.find('#vkeyb');
        var $vmouse = $workspace.find('#vmouse');
        var $drives = $workspace.find('#drives');
        var $debug = $workspace.find('#debug');
        var $container = $(document.body);

        var display = $display[0];
        var vkeyb = $vkeyb[0];
        var vmouse = $vmouse[0];
        var debug = $debug[0];
        var drives = $drives[0];
        var container = $container[0];

        this.get_container = function () {
            return container;
        }

        this.get_display = function () {
            return display;
        }

        this.get_keyboard = function () {
            return vkeyb;
        }

        this.get_mouse = function () {
            return vmouse;
        }

        this.get_debug = function () {
            return debug;
        }

        this.init = init;
        this.adjustWorkspaceLayout = adjustWorkspaceLayout;
       
        function init() {
            $container.append($workspace);
            initToolbar();
            initKeyboard();
            initLayout();
            initVirtualKeyboard();
            initVirtualMouse();
            initVirtualDisplay();
            applySettings();
        }

        function initLayout() {
            $(window).resize(adjustWorkspaceLayout);
            adjustWorkspaceLayout();
        }

        function initKeyboard() {
            ZXContext.ui.keyboard = new PCKeyboard();
            ZXContext.ui.keyboard.get_onKeysStateChanged().subscribe(function (args) {
                ZXContext.hw.keyboard.switchKeys(args.keys, args.pressed);
            });
        }

        function initVirtualKeyboard() {
	        // подключение виртуальной клавиатуры
            ZXContext.ui.vkeyboard = new VirtualKeyboard(control);
            ZXContext.ui.vkeyboard.get_onKeysStateChanged().subscribe(function (args) {
                ZXContext.hw.keyboard.switchKeys(args.keys, args.pressed);
            });
            ZXContext.hw.keyboard.get_onKeysStateChanged().subscribe(function ( args ) {
                for ( var i = 0; i < args.keys.length; i++ ) {
                    ZXContext.ui.vkeyboard.updateKeyState(args.keys[i], args.pressed);
                }
            });
        }

        function initVirtualMouse() {
            // подключение виртуальной мыши
            ZXContext.ui.vmouse = new VirtualMouse(control);
            ZXContext.ui.vmouse.get_onKeyStateChanged().subscribe(function (args) {
                ZXContext.hw.mouse.switchButton(args.key, args.pressed);
            });
            ZXContext.ui.vmouse.get_onMove().subscribe(function (args) {
                args.offsetX && ZXContext.hw.mouse.moveX(args.offsetX);
                args.offsetY && ZXContext.hw.mouse.moveY(args.offsetY);
            });
            ZXContext.hw.mouse.get_onAction().subscribe(function (state) {
                if (state.type == 'key') {
                    ZXContext.ui.vmouse.refreshKeyState(state.num, state.pressed);
                }
            });
        }

        function initVirtualDisplay() {
            ZXContext.ui.vdisplay = new VirtualDisplay($display[0]);
            ZXContext.ui.vdisplay.get_onInitialized().subscribe(function (args) {
                ZXContext.hw.display.bind(args.canvases);
            });
        }

        function initToolbar() {
            $('#commands>a').button({ text: false });
            $('#commands>a').click(function (e) {
                var command = $(e.target).closest('a').attr('data-command');
                switch ( command ) {
                    case 'reset': reset(); break;
                    case 'settings': openProperties(); break;
                    case 'snapshot-open': openSnapshot(); break;
                    case 'snapshot-save': saveSnapshot(); break;
                    case 'about': about(); break;
                }
            });

            var driveDispatcher = new ZX_DriveDispatcher(drives);
            driveDispatcher.addDriveBoxes();
            driveDispatcher.preloadImages();
            ZXContext.ui.driveDispatcher = driveDispatcher;
        }

        function adjustWorkspaceLayout() {
            var $main_container = $('#main_container');
            var $l = $('#left_field');
            var $c = $('#center_field');
            var $r = $('#right_field');

            $main_container
                .css('width', Math.ceil($l.outerWidth() + $c.outerWidth() + $r.outerWidth()) + 'px');
        }

        function reset() {
            ZXContext.hw.bus.reset();
        }

        function openSnapshot() {
            var $input = $('<input type="file" accept=".sna,.z80" style="visibility: hidden;" />').appendTo(document.body);
            $input.on('change', function (e) {
                var filename = ($input.val() || '').replace(/^.*[\\\/]/, '');
                if (!filename)
                    return;

                Promise.all([]).then(function () {
                    var format = ((/\.(SNA|Z80)/i).exec(filename)[1] || '').toUpperCase();
                    if (format != 'SNA' && format != 'Z80')
                        throw new Error('Неподдерживаемый формат файла.');
                    return loadLocalFile($input[0]).then(function (data) {
                        var snapshot = null;
                        switch (format) {
                            case 'SNA': snapshot = ZX_Snapshot.createFromSNA(data); break;
                            case 'Z80': snapshot = ZX_Snapshot.createFromZ80(data); break;
                        }
                        if (snapshot) {
                            ZX_Snapshot.restore(snapshot, ZXContext.hw.bus, ZXContext.hw.cpu);
                        }
                    })
                }).catch(function (errorMessage) {
                    if (errorMessage) {
                        alert(errorMessage);
                    }
                });
            });
            $input.click();
        }

        function saveSnapshot() {
            var snapshot = ZX_Snapshot.take(ZXContext.hw.bus, ZXContext.hw.cpu);
            var data = ZX_Snapshot.saveToSNA(snapshot);
		    downloadBinaryData(data, 'snapshot.sna');
        }

        function openProperties() {
            var dlg = new SettingsDialog();
            dlg.open().then(function (settingsChanged) {
                if (settingsChanged) {
                    applySettings();
                }
            });
        }

        function about() {
            var dlg = new AboutDialog();
        }

        function applySettings() {
            var s = ZXContext.settings;
            ZXContext.hw.bus.opt(OPT_TSTATES_PER_INTRQ, s.get_turboMode() ? s.get_tstatesPerIntrqTurbo() : s.get_tstatesPerIntrq());
            ZXContext.hw.bus.opt(OPT_INTRQ_PERIOD, s.get_intrqPeriod());
            ZXContext.hw.bus.opt(OPT_EXTENDED_MEMORY, s.get_extendedMemory());
            ZXContext.hw.bus.opt(OPT_SEMICOLORS, s.get_semicolors());
            ZXContext.hw.bus.opt(OPT_RENDERING_PARAMS, {
                scale: s.get_scaleValue(),
                scaleType: s.get_scaleType(),
                rendererType: s.get_rendererType(),
                renderOnAnimationFrame: s.get_renderOnAnimationFrame()
            });
            ZXContext.hw.psg.applySettings(
                s.get_psg(),
                s.get_psgClock(),
                s.get_psgBufferSize()
            );
            ZXContext.ui.vdisplay.init(
                16, 
                ZXContext.settings.get_scaleValue(), 
                ZXContext.settings.get_scaleType(), 
                ZXContext.settings.get_rendererType());
        }
    }
</script>