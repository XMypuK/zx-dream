<style>
.ui-dialog .save-image-dialog { padding: 0.5em; }
</style>

<template id="save-image-dialog">
	<div class="save-image-dialog">
		<table>
			<tr>
				<td class="title">Формат:</td>
				<td class="data">
					<label><input type="radio" name="format" value="TRD" />&nbsp;TRD</label>
					<label><input type="radio" name="format" value="SCL" />&nbsp;SCL</label>
					<label><input type="radio" name="format" value="FDI" />&nbsp;FDI</label>
				</td>
			</tr>
		</table>
	</div>
</template>

<script type="text/javascript">
	function SaveImageDialog () {
		'use strict';
		
		var $dlg = null;
		var openResult$ = null;
		var formats = null;

		this.open = open;

		function open(compatible_formats) {
			if (!openResult$) {
				openResult$ = $.Deferred();
				formats = compatible_formats;
				formats.sort();
				init();
			}
			return openResult$;
		}

		function init() {
			var temp_div = document.createElement('div');
			temp_div.innerHTML = "<?=save-image-dialog?>";

			$dlg = $(temp_div).children('.save-image-dialog');
			$dlg.dialog({
				autoOpen: true,
				title: 'Выберите целевой формат образа',
				modal: true,
				width: 400,
				height: 120,
				buttons: [
					{ text: 'Сохранить', click: save },
					{ text: 'Отмена', click: cancel }
				],
				close: function (e) { 
					$(this).dialog('destroy');
					$(this).remove(); 
					if (openResult$) {
						openResult$.reject();
						openResult$ = null;
					}
				}
			});
			$dlg.on('keydown', function(e) { e.stopPropagation(); });
			$dlg.on('keyup', function(e) { e.stopPropagation(); });

			var $data = $dlg.find('.data');
			$data.empty();
			for (var i = 0; i < formats.length; i++) {
				$data.append('<label><input type="radio" name="format" value="' + formats[i] + '" />&nbsp;' + formats[i] + '</label>');
			}
		}

		function save() {
			var $format = $dlg.find('[name=format]:checked');
			if (!$format.length) {
				alert('You have to choice an image format.')
				return;
			}

			if (openResult$) {
				openResult$.resolve($format.val());
				openResult$ = null;
			}
			$dlg.dialog('close');
			$dlg = null;
		}

		function cancel() {
			if (openResult$) {
				openResult$.reject();
				openResult$ = null;
			}			
			$dlg.dialog('close');
			$dlg = null;
		}
	}
</script>